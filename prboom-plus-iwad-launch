#!/bin/bash

# if "$SNAP/doom-engine" exists we can expect this to run
# as a content snap within, say, a DOOM map editor.
# On the confinement side the script runs within the parents sandbox.

if [ -d "$SNAP/doom-engine" ]; then
    export SNAP="${SNAP}/doom-engine"
fi

if [[ "$@" == "" ]]; then
    IWAD_FILENAME=""
    PWAD_FILENAME=""

    IWAD_FILENAME=`zenity \
      --file-selection \
      --title='Select the *.wad to play' \
      --file-filter='WAD file | *.wad *.WAD *.iwad *.IWAD *.pwad *.PWAD'`
    if [ "$IWAD_FILENAME" == "" ]; then
        exit 1
    fi
    filetype=`LANG=C file -m $SNAP/usr/share/file/magic.mgc $IWAD_FILENAME`

    # select additional IWAD file via zenity
    if [[ $filetype = *"PWAD data"* ]]; then
        PWAD_FILENAME="$IWAD_FILENAME"
        IWAD_FILENAME=`zenity \
          --file-selection \
          --title='Select the corresponding IWAD *.wad to continue' \
          --file-filter='WAD file | *.wad *.WAD *.iwad *.IWAD'`
        if [ "$IWAD_FILENAME" == "" ]; then
            exit 1
        fi
    fi

    exec "$SNAP/command-prboom-plus.wrapper" "-iwad" "$IWAD_FILENAME" "-file" "$PWAD_FILENAME"
else
    exec "$SNAP/command-prboom-plus.wrapper" "$@"
fi
